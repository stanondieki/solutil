<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Admin System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .success { border-color: #4CAF50; background: #f1f8e9; }
        .error { border-color: #f44336; background: #ffebee; }
        .warning { border-color: #ff9800; background: #fff3e0; }
        .pending { border-color: #2196F3; background: #e3f2fd; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .test-all-btn {
            background: #28a745;
            font-size: 16px;
            padding: 12px 24px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #4CAF50; }
        .status-error { background: #f44336; }
        .status-pending { background: #ff9800; }
        .status-idle { background: #ccc; }
        .summary {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è Complete Admin System Integration Test</h1>
        <p>This comprehensive test verifies that all admin functionalities are using real backend data with no mock data remaining.</p>
        
        <div class="summary" id="testSummary">
            <span class="status-indicator status-idle"></span>
            Ready to test all admin modules
        </div>

        <div class="container">
            <button class="test-all-btn" onclick="runAllTests()">üöÄ Test All Admin Modules</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
            <button onclick="openAdminPanel()">üîó Open Admin Panel</button>
        </div>
    </div>

    <div class="test-grid">
        <!-- Authentication Test -->
        <div class="test-section" id="authSection">
            <h3><span class="status-indicator status-idle" id="authStatus"></span>Admin Authentication</h3>
            <button onclick="testAuthentication()">Test Login</button>
            <div id="authResult"></div>
        </div>

        <!-- Dashboard Statistics Test -->
        <div class="test-section" id="dashboardSection">
            <h3><span class="status-indicator status-idle" id="dashboardStatus"></span>Dashboard Statistics</h3>
            <button onclick="testDashboardStats()">Test Real Stats</button>
            <div id="dashboardResult"></div>
        </div>

        <!-- User Management Test -->
        <div class="test-section" id="usersSection">
            <h3><span class="status-indicator status-idle" id="usersStatus"></span>User Management</h3>
            <button onclick="testUserManagement()">Test Users</button>
            <button onclick="testUserStatusUpdate()">Test Status Update</button>
            <div id="usersResult"></div>
        </div>

        <!-- Service Management Test -->
        <div class="test-section" id="servicesSection">
            <h3><span class="status-indicator status-idle" id="servicesStatus"></span>Service Management</h3>
            <button onclick="testServiceManagement()">Test Services</button>
            <button onclick="testServiceCreation()">Test Create Service</button>
            <div id="servicesResult"></div>
        </div>

        <!-- Provider Management Test -->
        <div class="test-section" id="providersSection">
            <h3><span class="status-indicator status-idle" id="providersStatus"></span>Provider Management</h3>
            <button onclick="testProviderManagement()">Test Providers</button>
            <button onclick="testProviderStatusUpdate()">Test Status Update</button>
            <div id="providersResult"></div>
        </div>

        <!-- Booking Management Test -->
        <div class="test-section" id="bookingsSection">
            <h3><span class="status-indicator status-idle" id="bookingsStatus"></span>Booking Management</h3>
            <button onclick="testBookingManagement()">Test Bookings</button>
            <button onclick="testBookingStatusUpdate()">Test Status Update</button>
            <div id="bookingsResult"></div>
        </div>
    </div>

    <div class="container">
        <h3>Test Results Summary</h3>
        <div id="testLog"></div>
    </div>

    <script>
        let adminToken = null;
        let testResults = {};

        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
            console.log(message);
        }

        function updateStatus(moduleId, status, message = '') {
            const statusIndicator = document.getElementById(`${moduleId}Status`);
            const section = document.getElementById(`${moduleId}Section`);
            
            statusIndicator.className = `status-indicator status-${status}`;
            section.className = `test-section ${status}`;
            
            testResults[moduleId] = { status, message };
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('testSummary');
            const modules = Object.keys(testResults);
            
            if (modules.length === 0) {
                summary.innerHTML = '<span class="status-indicator status-idle"></span>Ready to test all admin modules';
                return;
            }

            const successCount = modules.filter(m => testResults[m].status === 'success').length;
            const errorCount = modules.filter(m => testResults[m].status === 'error').length;
            const pendingCount = modules.filter(m => testResults[m].status === 'pending').length;
            
            let summaryStatus = 'success';
            if (errorCount > 0) summaryStatus = 'error';
            else if (pendingCount > 0) summaryStatus = 'pending';
            
            summary.innerHTML = `
                <span class="status-indicator status-${summaryStatus}"></span>
                Tests: ${successCount} ‚úÖ | ${errorCount} ‚ùå | ${pendingCount} ‚è≥
            `;
        }

        async function testAuthentication() {
            updateStatus('auth', 'pending');
            try {
                log('üîê Testing admin authentication...');
                
                const response = await fetch('/api/admin/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@example.com',
                        password: 'admin123'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.token) {
                    adminToken = result.token;
                    localStorage.setItem('adminToken', adminToken);
                    
                    document.getElementById('authResult').innerHTML = `
                        <h5>‚úÖ Authentication Success</h5>
                        <p><strong>Admin:</strong> ${result.user.email}</p>
                        <p><strong>Role:</strong> ${result.user.userType}</p>
                    `;
                    
                    updateStatus('auth', 'success');
                    log('‚úÖ Admin authentication successful', 'success');
                    return true;
                } else {
                    throw new Error(result.message || 'Login failed');
                }
            } catch (error) {
                document.getElementById('authResult').innerHTML = `
                    <h5>‚ùå Authentication Failed</h5>
                    <p>${error.message}</p>
                `;
                updateStatus('auth', 'error', error.message);
                log(`‚ùå Authentication failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testDashboardStats() {
            if (!adminToken) {
                alert('Please authenticate first');
                return;
            }
            
            updateStatus('dashboard', 'pending');
            try {
                log('üìä Testing dashboard statistics...');
                
                const response = await fetch('/api/admin/dashboard/stats', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const result = await response.json();
                
                if (response.ok && result.data) {
                    document.getElementById('dashboardResult').innerHTML = `
                        <h5>‚úÖ Dashboard Stats Retrieved</h5>
                        <p><strong>Users:</strong> ${result.data.totalUsers}</p>
                        <p><strong>Providers:</strong> ${result.data.totalProviders}</p>
                        <p><strong>Bookings:</strong> ${result.data.totalBookings}</p>
                        <p><strong>Revenue:</strong> KES ${result.data.totalRevenue?.toLocaleString()}</p>
                    `;
                    
                    updateStatus('dashboard', 'success');
                    log('‚úÖ Dashboard statistics loaded from database', 'success');
                    return true;
                } else {
                    throw new Error(result.message || 'Failed to fetch stats');
                }
            } catch (error) {
                document.getElementById('dashboardResult').innerHTML = `
                    <h5>‚ùå Dashboard Stats Failed</h5>
                    <p>${error.message}</p>
                `;
                updateStatus('dashboard', 'error', error.message);
                log(`‚ùå Dashboard stats failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testUserManagement() {
            if (!adminToken) {
                alert('Please authenticate first');
                return;
            }
            
            updateStatus('users', 'pending');
            try {
                log('üë• Testing user management...');
                
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const result = await response.json();
                
                if (response.ok && result.users) {
                    const users = result.users;
                    document.getElementById('usersResult').innerHTML = `
                        <h5>‚úÖ Users Retrieved</h5>
                        <p><strong>Total Users:</strong> ${users.length}</p>
                        <p><strong>Sample User:</strong> ${users[0]?.name || 'None'}</p>
                        <p><strong>Data Source:</strong> Real Database</p>
                    `;
                    
                    updateStatus('users', 'success');
                    log(`‚úÖ User management working with ${users.length} real users`, 'success');
                    return users;
                } else {
                    throw new Error(result.message || 'Failed to fetch users');
                }
            } catch (error) {
                document.getElementById('usersResult').innerHTML = `
                    <h5>‚ùå User Management Failed</h5>
                    <p>${error.message}</p>
                `;
                updateStatus('users', 'error', error.message);
                log(`‚ùå User management failed: ${error.message}`, 'error');
                return null;
            }
        }

        async function testUserStatusUpdate() {
            const users = await testUserManagement();
            if (!users || users.length === 0) {
                log('‚ö†Ô∏è No users available for status update test', 'warning');
                return;
            }
            
            try {
                const testUser = users[0];
                const newStatus = testUser.status === 'active' ? 'suspended' : 'active';
                
                log(`üîÑ Testing user status update: ${testUser.name} ‚Üí ${newStatus}`);
                
                const response = await fetch(`/api/admin/users/${testUser.id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    log('‚úÖ User status update successful', 'success');
                } else {
                    throw new Error('Status update failed');
                }
            } catch (error) {
                log(`‚ùå User status update failed: ${error.message}`, 'error');
            }
        }

        async function testServiceManagement() {
            if (!adminToken) {
                alert('Please authenticate first');
                return;
            }
            
            updateStatus('services', 'pending');
            try {
                log('üõ†Ô∏è Testing service management...');
                
                const response = await fetch('/api/admin/services', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const result = await response.json();
                
                if (response.ok && result.data) {
                    const services = result.data.services || [];
                    document.getElementById('servicesResult').innerHTML = `
                        <h5>‚úÖ Services Retrieved</h5>
                        <p><strong>Total Services:</strong> ${services.length}</p>
                        <p><strong>Sample Service:</strong> ${services[0]?.name || 'None'}</p>
                        <p><strong>Data Source:</strong> Real Database</p>
                    `;
                    
                    updateStatus('services', 'success');
                    log(`‚úÖ Service management working with ${services.length} real services`, 'success');
                    return services;
                } else {
                    throw new Error(result.message || 'Failed to fetch services');
                }
            } catch (error) {
                document.getElementById('servicesResult').innerHTML = `
                    <h5>‚ùå Service Management Failed</h5>
                    <p>${error.message}</p>
                `;
                updateStatus('services', 'error', error.message);
                log(`‚ùå Service management failed: ${error.message}`, 'error');
                return null;
            }
        }

        async function testServiceCreation() {
            if (!adminToken) {
                alert('Please authenticate first');
                return;
            }
            
            try {
                log('‚ûï Testing service creation...');
                
                const testService = {
                    name: `Test Service ${Date.now()}`,
                    description: 'Auto-generated test service',
                    category: 'testing',
                    basePrice: 1000,
                    currency: 'KES',
                    duration: { estimated: 60 },
                    priceType: 'fixed',
                    isActive: true
                };
                
                const response = await fetch('/api/admin/services', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testService)
                });
                
                if (response.ok) {
                    log('‚úÖ Service creation successful', 'success');
                } else {
                    const error = await response.text();
                    throw new Error(`Service creation failed: ${error}`);
                }
            } catch (error) {
                log(`‚ùå Service creation failed: ${error.message}`, 'error');
            }
        }

        async function testProviderManagement() {
            if (!adminToken) {
                alert('Please authenticate first');
                return;
            }
            
            updateStatus('providers', 'pending');
            try {
                log('üë∑ Testing provider management...');
                
                const response = await fetch('/api/admin/providers', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const result = await response.json();
                
                if (response.ok && result.users) {
                    const providers = result.users.filter(u => u.userType === 'provider');
                    document.getElementById('providersResult').innerHTML = `
                        <h5>‚úÖ Providers Retrieved</h5>
                        <p><strong>Total Providers:</strong> ${providers.length}</p>
                        <p><strong>Sample Provider:</strong> ${providers[0]?.name || 'None'}</p>
                        <p><strong>Data Source:</strong> Real Database</p>
                    `;
                    
                    updateStatus('providers', 'success');
                    log(`‚úÖ Provider management working with ${providers.length} real providers`, 'success');
                    return providers;
                } else {
                    throw new Error(result.message || 'Failed to fetch providers');
                }
            } catch (error) {
                document.getElementById('providersResult').innerHTML = `
                    <h5>‚ùå Provider Management Failed</h5>
                    <p>${error.message}</p>
                `;
                updateStatus('providers', 'error', error.message);
                log(`‚ùå Provider management failed: ${error.message}`, 'error');
                return null;
            }
        }

        async function testProviderStatusUpdate() {
            const providers = await testProviderManagement();
            if (!providers || providers.length === 0) {
                log('‚ö†Ô∏è No providers available for status update test', 'warning');
                return;
            }
            
            try {
                const testProvider = providers[0];
                const newStatus = testProvider.providerStatus === 'verified' ? 'pending' : 'verified';
                
                log(`üîÑ Testing provider status update: ${testProvider.name} ‚Üí ${newStatus}`);
                
                const response = await fetch(`/api/admin/providers/${testProvider._id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    log('‚úÖ Provider status update successful', 'success');
                } else {
                    throw new Error('Provider status update failed');
                }
            } catch (error) {
                log(`‚ùå Provider status update failed: ${error.message}`, 'error');
            }
        }

        async function testBookingManagement() {
            if (!adminToken) {
                alert('Please authenticate first');
                return;
            }
            
            updateStatus('bookings', 'pending');
            try {
                log('üìÖ Testing booking management...');
                
                const response = await fetch('/api/admin/bookings', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const bookings = result.data?.bookings || [];
                    document.getElementById('bookingsResult').innerHTML = `
                        <h5>‚úÖ Bookings Retrieved</h5>
                        <p><strong>Total Bookings:</strong> ${bookings.length}</p>
                        <p><strong>Sample Booking:</strong> ${bookings[0]?.bookingNumber || 'None'}</p>
                        <p><strong>Data Source:</strong> Real Database</p>
                    `;
                    
                    updateStatus('bookings', 'success');
                    log(`‚úÖ Booking management working with ${bookings.length} real bookings`, 'success');
                    return bookings;
                } else {
                    throw new Error(result.message || 'Failed to fetch bookings');
                }
            } catch (error) {
                document.getElementById('bookingsResult').innerHTML = `
                    <h5>‚ùå Booking Management Failed</h5>
                    <p>${error.message}</p>
                `;
                updateStatus('bookings', 'error', error.message);
                log(`‚ùå Booking management failed: ${error.message}`, 'error');
                return null;
            }
        }

        async function testBookingStatusUpdate() {
            const bookings = await testBookingManagement();
            if (!bookings || bookings.length === 0) {
                log('‚ö†Ô∏è No bookings available for status update test', 'warning');
                return;
            }
            
            try {
                const testBooking = bookings[0];
                const newStatus = testBooking.status === 'confirmed' ? 'in-progress' : 'confirmed';
                
                log(`üîÑ Testing booking status update: ${testBooking.bookingNumber} ‚Üí ${newStatus}`);
                
                const response = await fetch(`/api/admin/bookings/${testBooking._id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    log('‚úÖ Booking status update successful', 'success');
                } else {
                    throw new Error('Booking status update failed');
                }
            } catch (error) {
                log(`‚ùå Booking status update failed: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            log('üöÄ Starting comprehensive admin system test...');
            testResults = {};
            
            // Test authentication first
            const authSuccess = await testAuthentication();
            if (!authSuccess) {
                log('‚ùå Cannot continue tests without authentication', 'error');
                return;
            }
            
            // Run all other tests in sequence
            await testDashboardStats();
            await testUserManagement();
            await testUserStatusUpdate();
            await testServiceManagement();
            await testServiceCreation();
            await testProviderManagement();
            await testProviderStatusUpdate();
            await testBookingManagement();
            await testBookingStatusUpdate();
            
            log('üèÅ All admin tests completed!');
        }

        function clearResults() {
            testResults = {};
            const sections = ['auth', 'dashboard', 'users', 'services', 'providers', 'bookings'];
            sections.forEach(section => {
                updateStatus(section, 'idle');
                document.getElementById(`${section}Result`).innerHTML = '';
            });
            document.getElementById('testLog').innerHTML = '';
            updateSummary();
            log('üóëÔ∏è Test results cleared');
        }

        function openAdminPanel() {
            log('üîó Opening admin panel in new tab');
            window.open('/admin/login', '_blank');
        }

        // Initialize
        window.addEventListener('load', () => {
            log('üß™ Complete Admin System Test Ready');
            log('üí° Click "Test All Admin Modules" to verify all functionalities use real data');
            
            // Auto-load token if available
            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                adminToken = savedToken;
                log('üîë Found existing admin token');
            }
        });
    </script>
</body>
</html>